<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Fuel & Flex</title>

    <!-- Favicon Section -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="Images/LOGO.jpg">
    <link rel="icon" type="image/png" sizes="32x32" href="Images/LOGO.jpg">
    <link rel="apple-touch-icon" sizes="180x180" href="Images/LOGO.jpg">
    <link rel="icon" type="image/png" sizes="192x192" href="Images/LOGO.png">
    <link rel="icon" type="image/png" sizes="512x512" href="Images/LOGO.png">
    <link rel="manifest" href="site.webmanifest">
    <meta name="theme-color" content="#278cf8">
    <meta name="msapplication-TileColor" content="#278cf8">
    <meta name="msapplication-config" content="browserconfig.xml">

    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        .profile-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-header h1 {
            color: var(--light-color);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .profile-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .profile-avatar {
            text-align: center;
            margin-bottom: 2rem;
        }

        .avatar-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .avatar-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            color: white;
        }

        .profile-info {
            display: grid;
            gap: 1.5rem;
        }

        .info-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .info-value {
            color: var(--light-color);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-edit-profile {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-edit-profile:hover {
            background: #1e6db8;
            transform: translateY(-2px);
        }

        .btn-change-password {
            background: var(--secondary-color);
            color: var(--dark-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-change-password:hover {
            background: #eab308;
            transform: translateY(-2px);
        }

        .btn-logout {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-logout:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .back-btn:hover {
            color: var(--secondary-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .profile-container {
                margin: 1rem auto;
                padding: 0 0.5rem;
            }

            .profile-card {
                padding: 1.5rem;
            }

            .profile-actions {
                flex-direction: column;
                gap: 0.75rem;
            }

            .btn-edit-profile,
            .btn-change-password,
            .btn-logout {
                width: 100%;
                justify-content: center;
            }

            .profile-header h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="profile-container" id="profile-content">
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Back to Home
        </a>

        <div class="profile-header">
            <h1>My Profile</h1>
            <p>Your account information</p>
        </div>

        <!-- User Info Section -->
        <div class="profile-card">
            <div class="profile-avatar">
                <div class="avatar-placeholder" id="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <h2 id="user-display-name">Loading...</h2>
            </div>

            <div class="profile-info">
                <div class="info-group">
                    <div class="info-label">Name</div>
                    <div class="info-value" id="user-name">Loading...</div>
                </div>

                <div class="info-group">
                    <div class="info-label">Email</div>
                    <div class="info-value" id="user-email">Loading...</div>
                </div>

                <div class="info-group">
                    <div class="info-label">Phone Number</div>
                    <div class="info-value" id="user-phone">Not provided</div>
                </div>
            </div>

            <div class="profile-actions">
                <button class="btn-edit-profile" onclick="showUpdatePhoneForm()">
                    <i class="fas fa-phone"></i>
                    Update Phone
                </button>
                <button class="btn-logout" onclick="logoutUser()">
                    <i class="fas fa-sign-out-alt"></i>
                    Log Out
                </button>
            </div>
        </div>

        <!-- Phone Number Update Section -->
        <div class="profile-card" id="phone-update-section" style="display: none;">
            <h3 style="color: var(--light-color); margin-bottom: 1rem;">Update Phone Number</h3>

            <div style="margin-bottom: 1.5rem;">
                <input type="tel" id="phone-input" placeholder="Enter your phone number (e.g., +91 9876543210)"
                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
            </div>

            <div style="display: flex; gap: 1rem;">
                <button onclick="updatePhoneNumber()" class="btn-edit-profile">
                    <i class="fas fa-save"></i>
                    Save Phone Number
                </button>
                <button onclick="cancelPhoneUpdate()" class="btn-change-password">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
            </div>
        </div>

        <!-- Address Section -->
        <div class="profile-card" id="addresses">
            <h3 style="color: var(--light-color); margin-bottom: 1rem;">My Addresses</h3>

            <!-- Add New Address Form -->
            <div id="add-address-form" style="display: none;">
                <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="text" id="firstName" placeholder="First Name" style="padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                        <input type="text" id="lastName" placeholder="Last Name" style="padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                    </div>
                    <input type="text" id="address" placeholder="Address Line 1" style="padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                    <input type="text" id="address2" placeholder="Address Line 2 (Optional)" style="padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <input type="text" id="city" placeholder="City" style="padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                        <input type="text" id="state" placeholder="State" style="padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                        <input type="text" id="postal" placeholder="Postal Code" style="padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                    </div>
                    <select id="addressType" style="padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                        <option value="shipping">Shipping Address</option>
                        <option value="billing">Billing Address</option>
                    </select>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button onclick="saveAddress()" class="btn-edit-profile">
                        <i class="fas fa-save"></i>
                        Save Address
                    </button>
                    <button onclick="cancelAddAddress()" class="btn-change-password">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Add Address Button -->
            <button id="add-address-btn" onclick="showAddAddressForm()" class="btn-edit-profile" style="margin-bottom: 1.5rem;">
                <i class="fas fa-plus"></i>
                Add New Address
            </button>

            <!-- Saved Addresses List -->
            <div id="addresses-list">
                <p style="color: rgba(255,255,255,0.7);">Loading addresses...</p>
            </div>
        </div>
    <script>
        // If navigated with #addresses, scroll there after load
        document.addEventListener('DOMContentLoaded', () => {
            if (location.hash === '#addresses') {
                const el = document.getElementById('addresses');
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
    </script>
    </div>

    <script src="config.js"></script>
    <script>
        let currentUser = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Profile page loaded');

            // Try to initialize config if not loaded
            if (!window.config) {
                console.log('Config not found, trying to initialize...');
                try {
                    // Try to initialize Supabase directly
                    if (typeof window.supabase !== 'undefined') {
                        window.config = {
                            supabase: window.supabase.createClient(
                                'https://eepeczgqficpjjxhilam.supabase.co',
                                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlcGVjemdxZmljcGpqeGhpbGFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NDEyMjUsImV4cCI6MjA3MDExNzIyNX0.DNhly0nlshbFLIwB0nG0dfqthEbobd7FumKFMj8HEzQ',
                                {
                                    auth: {
                                        autoRefreshToken: true,
                                        persistSession: true,
                                        detectSessionInUrl: true
                                    }
                                }
                            )
                        };
                        console.log('Supabase initialized directly');
                    }
                } catch (error) {
                    console.error('Error initializing Supabase:', error);
                }
            }

            // Wait for config to load with longer timeout
            let attempts = 0;
            while ((!window.config || !window.config.supabase) && attempts < 100) {
                console.log(`Waiting for config... attempt ${attempts + 1}`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (!window.config || !window.config.supabase) {
                console.error('Config still not available after waiting');
                document.getElementById('profile-content').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è Configuration Error</p>
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 1.5rem;">Unable to load configuration. This might be a temporary issue.</p>
                        <button onclick="window.location.reload()" style="background: var(--primary-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            üîÑ Refresh Page
                        </button>
                        <br><br>
                        <a href="index.html" style="color: var(--primary-color); text-decoration: none;">‚Üê Back to Home</a>
                    </div>
                `;
                return;
            }

            console.log('Config loaded successfully, initializing auth...');
            await initAuth();
        });

        async function initAuth() {
            try {
                console.log('Getting session...');
                const { data: { session }, error } = await window.config.supabase.auth.getSession();

                console.log('Session result:', { session, error });

                if (error) {
                    console.error('Session error:', error);
                    throw error;
                }

                if (session && session.user) {
                    currentUser = session.user;
                    console.log('User authenticated:', currentUser.email);
                    console.log('User metadata:', currentUser.user_metadata);
                    loadProfile();
                } else {
                    console.log('No session found, redirecting to auth...');
                    // Not signed in, redirect to auth page
                    window.location.href = 'auth.html?redirect=profile.html';
                }
            } catch (error) {
                console.error('Auth error:', error);
                document.getElementById('profile-content').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: #ef4444; margin-bottom: 1rem;">üîê Authentication Error</p>
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 1.5rem;">Unable to verify your sign-in status.</p>
                        <a href="auth.html" style="background: var(--primary-color); color: white; text-decoration: none; padding: 0.75rem 1.5rem; border-radius: 8px; display: inline-block;">
                            üîë Sign In Again
                        </a>
                        <br><br>
                        <a href="index.html" style="color: var(--primary-color); text-decoration: none;">‚Üê Back to Home</a>
                    </div>
                `;
            }
        }

        function loadProfile() {
            if (!currentUser) {
                console.error('No current user available');
                return;
            }

            console.log('Loading profile for:', currentUser.email);
            console.log('User object:', currentUser);

            // Display user information
            const displayName = currentUser.user_metadata?.full_name ||
                               currentUser.user_metadata?.name ||
                               currentUser.email?.split('@')[0] ||
                               'User';

            console.log('Display name determined:', displayName);

            // Update profile display with error checking
            const userDisplayNameEl = document.getElementById('user-display-name');
            const userNameEl = document.getElementById('user-name');
            const userEmailEl = document.getElementById('user-email');

            if (userDisplayNameEl) {
                userDisplayNameEl.textContent = displayName;
                console.log('Set user-display-name to:', displayName);
            } else {
                console.error('user-display-name element not found');
            }

            if (userNameEl) {
                userNameEl.textContent = displayName;
                console.log('Set user-name to:', displayName);
            } else {
                console.error('user-name element not found');
            }

            if (userEmailEl) {
                userEmailEl.textContent = currentUser.email;
                console.log('Set user-email to:', currentUser.email);
            } else {
                console.error('user-email element not found');
            }

            // Load and display phone number from profiles table
            loadUserPhone();

            // Display avatar if available
            if (currentUser.user_metadata?.avatar_url) {
                const avatarContainer = document.getElementById('user-avatar');
                avatarContainer.innerHTML = `<img src="${currentUser.user_metadata.avatar_url}" alt="Profile Picture" class="avatar-img">`;
            }

            // Load saved addresses
            loadAddresses();

        }

        // Load user phone number from profiles table
        async function loadUserPhone() {
            try {
                console.log('Loading user phone number...');
                console.log('Current user ID:', currentUser?.id);

                if (!currentUser || !currentUser.id) {
                    console.error('No current user or user ID available');
                    const userPhoneEl = document.getElementById('user-phone');
                    if (userPhoneEl) {
                        userPhoneEl.textContent = 'Not provided';
                    }
                    return;
                }

                const { data: profiles, error } = await window.config.supabase
                    .from('profiles')
                    .select('phone')
                    .eq('id', currentUser.id)
                    .single();

                console.log('Phone query result:', { profiles, error });

                const userPhoneEl = document.getElementById('user-phone');
                if (userPhoneEl) {
                    if (error && error.code === 'PGRST116') {
                        // No profile exists yet
                        userPhoneEl.textContent = 'Not provided';
                        console.log('No profile found, showing "Not provided"');
                    } else if (error) {
                        console.error('Error loading phone:', error);
                        console.error('Error details:', error.message, error.details);
                        userPhoneEl.textContent = 'Error loading phone';
                    } else if (profiles && profiles.phone) {
                        userPhoneEl.textContent = profiles.phone;
                        console.log('Set user-phone to:', profiles.phone);
                    } else {
                        userPhoneEl.textContent = 'Not provided';
                        console.log('No phone number in profile, profiles data:', profiles);
                    }
                } else {
                    console.error('user-phone element not found');
                }
            } catch (error) {
                console.error('Error in loadUserPhone:', error);
                console.error('Error stack:', error.stack);
                const userPhoneEl = document.getElementById('user-phone');
                if (userPhoneEl) {
                    userPhoneEl.textContent = 'Error loading phone';
                }
            }
        }

        // Show phone update form
        function showUpdatePhoneForm() {
            const phoneSection = document.getElementById('phone-update-section');
            const phoneInput = document.getElementById('phone-input');
            const currentPhone = document.getElementById('user-phone').textContent;

            // Pre-fill with current phone if it exists and is not "Not provided"
            if (currentPhone && currentPhone !== 'Not provided' && currentPhone !== 'Error loading phone') {
                phoneInput.value = currentPhone;
            }

            phoneSection.style.display = 'block';
            phoneInput.focus();
        }

        // Cancel phone update
        function cancelPhoneUpdate() {
            const phoneSection = document.getElementById('phone-update-section');
            const phoneInput = document.getElementById('phone-input');

            phoneSection.style.display = 'none';
            phoneInput.value = '';
        }

        // Update phone number in Supabase
        async function updatePhoneNumber() {
            try {
                const phoneInput = document.getElementById('phone-input');
                const phoneNumber = phoneInput.value.trim();

                // Basic validation
                if (!phoneNumber) {
                    showNotification('Please enter a phone number', 'error');
                    return;
                }

                // Simple phone number validation (allows various formats)
                const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,15}$/;
                if (!phoneRegex.test(phoneNumber)) {
                    showNotification('Please enter a valid phone number', 'error');
                    return;
                }

                console.log('Updating phone number to:', phoneNumber);
                console.log('Current user ID:', currentUser?.id);

                if (!currentUser || !currentUser.id) {
                    console.error('No current user or user ID available for phone update');
                    showNotification('Authentication error. Please sign in again.', 'error');
                    return;
                }

                // Show loading state
                const saveBtn = document.querySelector('button[onclick="updatePhoneNumber()"]');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;

                // First, check if profile exists
                const { data: existingProfile, error: checkError } = await window.config.supabase
                    .from('profiles')
                    .select('id')
                    .eq('id', currentUser.id)
                    .single();

                console.log('Profile check result:', { existingProfile, checkError });
                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('Unexpected error checking profile:', checkError);
                }

                let result;
                if (checkError && checkError.code === 'PGRST116') {
                    // Profile doesn't exist, create it
                    console.log('Creating new profile with phone number...');
                    result = await window.config.supabase
                        .from('profiles')
                        .insert([{
                            id: currentUser.id,
                            phone: phoneNumber,
                            updated_at: new Date().toISOString()
                        }])
                        .select();
                } else if (!checkError) {
                    // Profile exists, update it
                    console.log('Updating existing profile with phone number...');
                    result = await window.config.supabase
                        .from('profiles')
                        .update({
                            phone: phoneNumber,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentUser.id)
                        .select();
                } else {
                    throw checkError;
                }

                console.log('Phone update result:', result);

                // Restore button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;

                if (result.error) {
                    console.error('Error updating phone:', result.error);
                    showNotification(`Error updating phone: ${result.error.message}`, 'error');
                    return;
                }

                console.log('Phone number updated successfully');
                showNotification('Phone number updated successfully!', 'success');

                // Update the display immediately
                document.getElementById('user-phone').textContent = phoneNumber;

                // Hide the form
                cancelPhoneUpdate();

                // Reload phone number from database to confirm it was saved
                setTimeout(() => {
                    loadUserPhone();
                }, 1000);

            } catch (error) {
                console.error('Error in updatePhoneNumber:', error);
                showNotification(`Error updating phone: ${error.message}`, 'error');

                // Restore button state
                const saveBtn = document.querySelector('button[onclick="updatePhoneNumber()"]');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Phone Number';
                    saveBtn.disabled = false;
                }
            }
        }

        // Load saved addresses
        async function loadAddresses() {
            try {
                const { data: addresses, error } = await window.config.supabase
                    .from('addresses')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading addresses:', error);
                    document.getElementById('addresses-list').innerHTML = '<p style="color: #ef4444;">Error loading addresses</p>';
                    return;
                }

                displayAddresses(addresses);
            } catch (error) {
                console.error('Error in loadAddresses:', error);
                document.getElementById('addresses-list').innerHTML = '<p style="color: #ef4444;">Error loading addresses</p>';
            }
        }

        // Display addresses
        function displayAddresses(addresses) {
            const addressesList = document.getElementById('addresses-list');

            if (addresses.length === 0) {
                addressesList.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No addresses saved yet</p>';
                return;
            }

            const addressesHTML = addresses.map(address => `
                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.1); position: relative;">
                    <!-- Delete button positioned in top-right corner -->
                    <button onclick="deleteAddress('${address.id}')" style="position: absolute; top: 0.75rem; right: 0.75rem; background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" onmouseover="this.style.background='#dc2626'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#ef4444'; this.style.transform='scale(1)'">
                        <i class="fas fa-trash"></i>
                    </button>

                    <!-- Address type tag -->
                    <div style="margin-bottom: 0.75rem;">
                        <span style="background: var(--primary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${address.type === 'shipping' ? 'Shipping' : 'Billing'}</span>
                    </div>

                    <!-- Address details -->
                    <div style="color: var(--light-color); padding-right: 3rem;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${address.full_name}</div>
                        <div style="color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">${address.address_line_1}</div>
                        ${address.address_line_2 ? `<div style="color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">${address.address_line_2}</div>` : ''}
                        <div style="color: rgba(255,255,255,0.8);">${address.city}, ${address.state} ${address.postal_code}</div>
                    </div>
                </div>
            `).join('');

            addressesList.innerHTML = addressesHTML;
        }

        // Show add address form
        function showAddAddressForm() {
            document.getElementById('add-address-form').style.display = 'block';
            document.getElementById('add-address-btn').style.display = 'none';
        }

        // Cancel add address
        function cancelAddAddress() {
            document.getElementById('add-address-form').style.display = 'none';
            document.getElementById('add-address-btn').style.display = 'block';
            clearAddressForm();
        }

        // Clear address form
        function clearAddressForm() {
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('address2').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('postal').value = '';
            document.getElementById('addressType').value = 'home';
        }

        // Save address to Supabase
        async function saveAddress() {
            try {
                console.log('Starting saveAddress function...');
                console.log('Current user:', currentUser);

                // Check if user is authenticated
                if (!currentUser || !currentUser.id) {
                    console.error('No authenticated user found');
                    showNotification('Please sign in to save addresses', 'error');
                    return;
                }

                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const address = document.getElementById('address').value.trim();
                const address2 = document.getElementById('address2').value.trim();
                const city = document.getElementById('city').value.trim();
                const state = document.getElementById('state').value.trim();
                const postal = document.getElementById('postal').value.trim();
                const addressType = document.getElementById('addressType').value;

                console.log('Form values:', { firstName, lastName, address, city, state, postal, addressType });

                // Validate required fields
                if (!firstName || !lastName || !address || !city || !state || !postal) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                console.log('Validation passed, preparing address data...');

                const addressData = {
                    user_id: currentUser.id,
                    type: addressType,
                    full_name: `${firstName} ${lastName}`,
                    address_line_1: address,
                    address_line_2: address2 || null,
                    city: city,
                    state: state,
                    postal_code: postal,
                    country: 'India',
                    is_default: false
                };

                console.log('Address data to save:', addressData);

                // Show loading state
                const saveBtn = document.querySelector('button[onclick="saveAddress()"]');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;

                console.log('Attempting to save to Supabase...');

                const { data, error } = await window.config.supabase
                    .from('addresses')
                    .insert([addressData])
                    .select();

                console.log('Supabase response:', { data, error });

                // Restore button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;

                if (error) {
                    console.error('Supabase error details:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    console.error('Error details:', error.details);

                    let errorMessage = 'Error saving address: ';
                    if (error.message.includes('permission')) {
                        errorMessage += 'Permission denied. Please check your account settings.';
                    } else if (error.message.includes('duplicate')) {
                        errorMessage += 'This address already exists.';
                    } else {
                        errorMessage += error.message;
                    }

                    showNotification(errorMessage, 'error');
                    return;
                }

                console.log('Address saved successfully:', data);
                showNotification('Address saved successfully!', 'success');

                // Hide form and reload addresses
                cancelAddAddress();
                loadAddresses();

            } catch (error) {
                console.error('Unexpected error in saveAddress:', error);
                console.error('Error stack:', error.stack);
                showNotification(`Unexpected error: ${error.message}`, 'error');

                // Restore button state if error occurred
                const saveBtn = document.querySelector('button[onclick="saveAddress()"]');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Address';
                    saveBtn.disabled = false;
                }
            }
        }

        // Delete address
        async function deleteAddress(addressId) {
            try {
                if (!confirm('Are you sure you want to delete this address?')) {
                    return;
                }

                console.log('Deleting address:', addressId);

                const { error } = await window.config.supabase
                    .from('addresses')
                    .delete()
                    .eq('id', addressId)
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('Error deleting address:', error);
                    alert('Error deleting address. Please try again.');
                    return;
                }

                console.log('Address deleted successfully');
                showNotification('Address deleted successfully!', 'success');

                // Reload addresses
                loadAddresses();

            } catch (error) {
                console.error('Error in deleteAddress:', error);
                alert('Error deleting address. Please try again.');
            }
        }

        // Logout user
        async function logoutUser() {
            try {
                if (!confirm('Are you sure you want to log out?')) {
                    return;
                }

                const { error } = await window.config.supabase.auth.signOut();

                if (error) {
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                    return;
                }

                showNotification('Logged out successfully!', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);

            } catch (error) {
                console.error('Error in logoutUser:', error);
                alert('Error logging out. Please try again.');
            }
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');

            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.success};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                font-weight: 500;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;

            notification.textContent = message;
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
